<!DOCTYPE html>
<meta charset="utf-8">


<body>

    <!-- load the d3.js library -->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script> -->
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script>

        function convertArrayOfObjectsToCSV(args) {
            var result, ctr, keys, columnDelimiter, lineDelimiter, data;

            data = args.data || null;
            if (data == null || !data.length) {
                return null;
            }

            columnDelimiter = args.columnDelimiter || ',';
            lineDelimiter = args.lineDelimiter || '\n';

            keys = Object.keys(data[0]);

            result = '';
            result += keys.join(columnDelimiter);
            result += lineDelimiter;

            data.forEach(function (item) {
                ctr = 0;
                keys.forEach(function (key) {
                    if (ctr > 0) result += columnDelimiter;

                    result += item[key];
                    ctr++;
                });
                result += lineDelimiter;
            });

            return result;
        }

        var filters = {
            'Country_Region': ['Australia'],
        };

        d3.csv("https://raw.githubusercontent.com/microsoft/Bing-COVID-19-Data/master/data/Bing-COVID19-Data.csv", function (csv) {
            csv = csv.filter(function (row) {
                // run through all the filters, returning a boolean
                return ['Country_Region'].reduce(function (pass, column) {
                    return pass && (
                        // pass if no filter is set
                        !filters[column] ||
                        // pass if the row's value is equal to the filter
                        // (i.e. the filter is set to a string)
                        row[column] === filters[column] ||
                        // pass if the row's value is in an array of filter values
                        filters[column].indexOf(row[column]) >= 0
                    );
                }, true);
            })
            //console.log(csv.length, csv);

            //let csvContent = "data:text/csv;charset=utf-8,";

            var csvContent = convertArrayOfObjectsToCSV({
                data: csv
            });
            if (csvContent == null) return;

            if (!csvContent.match(/^data:text\/csv/i)) {
                csvContent = 'data:text/csv;charset=utf-8,' + csvContent;
            }

            var data = encodeURI(csvContent);


            var link = document.createElement("a");
            link.setAttribute("href", data);
            link.setAttribute("download", "Covid-19.csv");
            document.body.appendChild(link); // Required for FF

            link.click(); // This will download the data file named "Covid-19.csv".
        });


    </script>
</body>